# 课程训练系统设计方案

## 一、反应力等级划分（基于反应速度）

根据人类反应速度的科学研究数据，将反应力分为 10 个等级：

| 等级 | 等级名称 | 反应时间范围 | 描述 | 对应人群 |
|------|---------|------------|------|---------|
| 1 | 初级 | > 400ms | 反应较慢，需要更多时间处理信息 | 普通未训练人群 |
| 2 | 初级+ | 350-400ms | 反应速度略低于平均水平 | 普通人群 |
| 3 | 中级 | 300-350ms | 达到普通人群平均水平 | 普通人群 |
| 4 | 中级+ | 250-300ms | 反应速度略高于平均水平 | 有一定训练的人群 |
| 5 | 高级 | 200-250ms | 反应速度较快，经过一定训练 | 训练有素的人群 |
| 6 | 高级+ | 150-200ms | 反应速度很快，专业训练水平 | 专业训练人群 |
| 7 | 专家 | 120-150ms | 接近职业水平 | 职业选手（入门） |
| 8 | 专家+ | 100-120ms | 职业水平 | 职业游戏选手、赛车手 |
| 9 | 大师 | 80-100ms | 顶尖职业水平 | 顶尖职业选手 |
| 10 | 大师+ | < 80ms | 接近人类极限 | 世界顶级选手 |

**说明**：
- 反应时间是指从刺激出现到做出反应的平均时间（毫秒）
- 测试方式：视觉反应测试（如点击屏幕上的颜色变化）
- 升级标准：连续 10 次测试的平均反应时间达到对应等级范围

## 二、数据库设计

### 2.1 课程表（courses）

存储课程基本信息，支持多种类型的课程内容。

```sql
CREATE TABLE pikun_db.courses (
    course_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    code VARCHAR(50) NOT NULL UNIQUE,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    cover_image_url VARCHAR(500),
    course_type VARCHAR(50) NOT NULL, -- 'learning'（学习型）、'training'（训练型）、'mixed'（混合型）
    difficulty_level INTEGER DEFAULT 1, -- 难度等级 1-10
    estimated_duration INTEGER, -- 预计时长（分钟）
    sort_order INTEGER NOT NULL DEFAULT 0,
    is_published BOOLEAN NOT NULL DEFAULT false,
    metadata JSONB DEFAULT '{}'::JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP WITH TIME ZONE DEFAULT NULL
);
```

### 2.2 课程内容表（course_contents）

存储课程的具体内容，支持多种内容类型。

```sql
CREATE TABLE pikun_db.course_contents (
    content_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    course_id UUID NOT NULL REFERENCES pikun_db.courses(course_id) ON DELETE CASCADE,
    content_type VARCHAR(50) NOT NULL, -- 'video'、'article'、'game'、'training'、'interactive'
    title VARCHAR(200) NOT NULL,
    description TEXT,
    content_url VARCHAR(500), -- 内容资源 URL
    content_data JSONB, -- 存储游戏配置、训练参数等结构化数据
    duration INTEGER, -- 内容时长（秒）
    sort_order INTEGER NOT NULL DEFAULT 0,
    is_required BOOLEAN NOT NULL DEFAULT true, -- 是否必学
    metadata JSONB DEFAULT '{}'::JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP WITH TIME ZONE DEFAULT NULL
);
```

### 2.3 考试表（assessments）

存储考试信息，支持多种考试形式。

```sql
CREATE TABLE pikun_db.assessments (
    assessment_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    code VARCHAR(50) NOT NULL UNIQUE,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    assessment_type VARCHAR(50) NOT NULL, -- 'exam'（试卷）、'project'（项目）、'game'（游戏）、'performance'（表现评估）
    item_id UUID REFERENCES pikun_db.ability_items(item_id) ON DELETE SET NULL, -- 关联的能力项
    level_requirement INTEGER, -- 需要达到的等级（用于判断是否通过）
    passing_criteria JSONB, -- 通过标准（如：反应时间 < 200ms、正确率 > 80% 等）
    assessment_config JSONB, -- 考试配置（题目数量、时间限制、游戏规则等）
    exp_reward BIGINT DEFAULT 0, -- 通过后获得的经验值
    sort_order INTEGER NOT NULL DEFAULT 0,
    is_published BOOLEAN NOT NULL DEFAULT false,
    metadata JSONB DEFAULT '{}'::JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP WITH TIME ZONE DEFAULT NULL
);
```

### 2.4 课程与能力绑定表（course_ability_bindings）

建立课程与能力项的关联关系。

```sql
CREATE TABLE pikun_db.course_ability_bindings (
    binding_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    course_id UUID NOT NULL REFERENCES pikun_db.courses(course_id) ON DELETE CASCADE,
    item_id UUID NOT NULL REFERENCES pikun_db.ability_items(item_id) ON DELETE CASCADE,
    exp_reward BIGINT DEFAULT 0, -- 完成课程后获得的经验值
    is_primary BOOLEAN NOT NULL DEFAULT false, -- 是否为主要关联能力
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(course_id, item_id)
);
```

### 2.5 用户课程学习记录表（user_course_progress）

记录用户学习课程的进度。

```sql
CREATE TABLE pikun_db.user_course_progress (
    progress_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    uid BIGINT NOT NULL REFERENCES pikun_db.users(uid) ON DELETE CASCADE,
    course_id UUID NOT NULL REFERENCES pikun_db.courses(course_id) ON DELETE CASCADE,
    status VARCHAR(50) NOT NULL DEFAULT 'not_started', -- 'not_started'、'in_progress'、'completed'、'abandoned'
    progress_percentage DECIMAL(5,2) DEFAULT 0.00, -- 完成百分比
    completed_contents JSONB DEFAULT '[]'::JSONB, -- 已完成的课程内容 ID 列表
    started_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    last_accessed_at TIMESTAMP WITH TIME ZONE,
    metadata JSONB DEFAULT '{}'::JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(uid, course_id)
);
```

### 2.6 用户考试记录表（user_assessment_records）

记录用户参加考试的结果。

```sql
CREATE TABLE pikun_db.user_assessment_records (
    record_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    uid BIGINT NOT NULL REFERENCES pikun_db.users(uid) ON DELETE CASCADE,
    assessment_id UUID NOT NULL REFERENCES pikun_db.assessments(assessment_id) ON DELETE CASCADE,
    item_id UUID REFERENCES pikun_db.ability_items(item_id) ON DELETE SET NULL,
    score DECIMAL(10,2), -- 分数
    result_data JSONB, -- 详细结果数据（如：反应时间、正确率、游戏得分等）
    is_passed BOOLEAN NOT NULL DEFAULT false, -- 是否通过
    exp_earned BIGINT DEFAULT 0, -- 获得的经验值
    duration_seconds INTEGER, -- 考试耗时（秒）
    metadata JSONB DEFAULT '{}'::JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 2.7 训练记录表（user_training_records）

记录用户进行训练的数据（如反应力训练游戏）。

```sql
CREATE TABLE pikun_db.user_training_records (
    record_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    uid BIGINT NOT NULL REFERENCES pikun_db.users(uid) ON DELETE CASCADE,
    item_id UUID NOT NULL REFERENCES pikun_db.ability_items(item_id) ON DELETE CASCADE,
    course_content_id UUID REFERENCES pikun_db.course_contents(content_id) ON DELETE SET NULL,
    training_type VARCHAR(50) NOT NULL, -- 'game'、'practice'、'exercise'
    result_data JSONB NOT NULL, -- 训练结果数据（如：反应时间、得分、完成情况等）
    exp_earned BIGINT DEFAULT 0, -- 获得的经验值
    duration_seconds INTEGER, -- 训练耗时（秒）
    metadata JSONB DEFAULT '{}'::JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

## 三、升级机制设计

### 3.1 经验值获取方式

1. **学习课程内容**：完成课程内容（视频、文章等）获得基础经验值
2. **完成训练**：完成训练游戏/练习，根据表现获得经验值
3. **通过考试**：通过考试获得大量经验值
4. **达到等级标准**：直接通过考试达到等级标准，自动升级

### 3.2 升级判断逻辑

**方式一：经验值升级（通用）**
- 用户通过学习和训练积累经验值
- 当经验值达到等级配置的 `required_exp` 时，自动升级
- 如果 `requires_assessment = true`，需要先通过对应等级的考试

**方式二：直接达标升级（适用于可量化能力，如反应力）**
- 用户参加考试/训练，结果数据达到等级标准
- 系统自动判断是否达到对应等级
- 如果达到，直接升级到该等级，并给予相应经验值

**反应力升级示例**：
- 用户完成反应力测试游戏，平均反应时间为 180ms
- 系统判断：180ms 在 150-200ms 范围内，对应等级 6（高级+）
- 如果用户当前等级 < 6，则升级到等级 6
- 给予对应等级的经验值奖励

### 3.3 升级流程

```typescript
// 伪代码
async function processTrainingResult(uid: number, itemId: string, resultData: {
  reactionTime?: number; // 反应时间（ms）
  score?: number; // 得分
  // ... 其他结果数据
}) {
  // 1. 保存训练记录
  const record = await saveTrainingRecord(uid, itemId, resultData);
  
  // 2. 判断是否达到等级标准（针对可量化能力）
  if (resultData.reactionTime) {
    const targetLevel = getLevelByReactionTime(resultData.reactionTime);
    const currentLevel = await getUserLevel(uid, itemId);
    
    if (targetLevel > currentLevel) {
      // 3. 升级到目标等级
      await upgradeToLevel(uid, itemId, targetLevel);
      
      // 4. 给予经验值奖励
      const levelConfig = await getLevelConfig(itemId, targetLevel);
      await addExperience(uid, itemId, levelConfig.required_exp, {
        expType: 'level_up',
        sourceType: 'training',
        sourceId: record.record_id,
      });
    } else {
      // 5. 根据表现给予经验值
      const expAmount = calculateExpByPerformance(resultData);
      await addExperience(uid, itemId, expAmount, {
        expType: 'training',
        sourceType: 'training',
        sourceId: record.record_id,
      });
    }
  }
}
```

## 四、后端 API 设计

### 4.1 课程相关 API

```
GET    /api/courses                    # 获取课程列表
GET    /api/courses/:courseId          # 获取课程详情
GET    /api/courses/:courseId/contents # 获取课程内容列表
GET    /api/courses/by-ability/:itemId # 根据能力项获取课程列表

POST   /api/user/courses/:courseId/start      # 开始学习课程
POST   /api/user/courses/:courseId/complete-content # 完成课程内容
POST   /api/user/courses/:courseId/complete   # 完成课程
GET    /api/user/courses/progress             # 获取用户课程学习进度
```

### 4.2 考试相关 API

```
GET    /api/assessments                    # 获取考试列表
GET    /api/assessments/:assessmentId      # 获取考试详情
GET    /api/assessments/by-ability/:itemId # 根据能力项获取考试列表

POST   /api/user/assessments/:assessmentId/start  # 开始考试
POST   /api/user/assessments/:assessmentId/submit # 提交考试结果
GET    /api/user/assessments/records              # 获取用户考试记录
```

### 4.3 训练相关 API

```
POST   /api/user/training/submit          # 提交训练结果
GET    /api/user/training/records         # 获取用户训练记录
GET    /api/user/training/records/:itemId # 获取指定能力的训练记录
```

## 五、前端页面设计

### 5.1 管理端（Admin）

#### 5.1.1 课程管理页面
- 课程列表（卡片式布局）
- 创建/编辑课程（Drawer）
- 课程内容管理（嵌套在课程详情中）
- 课程与能力绑定管理

#### 5.1.2 考试管理页面
- 考试列表（卡片式布局）
- 创建/编辑考试（Drawer）
- 考试配置（根据考试类型动态表单）
- 考试结果查看

### 5.2 用户端（Test/C端）

#### 5.2.1 能力详情页面
- 显示能力信息
- 显示当前等级和进度
- 显示关联的课程列表
- 显示关联的考试列表
- 显示训练入口

#### 5.2.2 课程学习页面
- 课程内容展示（根据类型渲染不同组件）
- 学习进度显示
- 完成课程内容标记

#### 5.2.3 训练/考试页面
- 根据类型渲染不同的训练/考试界面
- 实时显示结果数据
- 提交结果并显示升级提示

## 六、实现步骤

1. **数据库迁移**：创建课程训练系统相关表
2. **后端 API**：实现课程、考试、训练的 CRUD 和业务逻辑
3. **管理端页面**：课程管理、考试管理
4. **用户端页面**：课程学习、训练/考试界面
5. **升级机制**：实现经验值升级和直接达标升级逻辑

## 七、技术要点

1. **内容类型扩展性**：使用 `content_type` 和 `content_data` JSONB 字段，支持未来扩展新的内容类型
2. **考试标准灵活性**：使用 `passing_criteria` JSONB 字段，支持不同能力的评估标准
3. **结果数据存储**：使用 JSONB 存储训练/考试结果，灵活适应不同能力的数据结构
4. **升级逻辑通用性**：设计通用的升级判断接口，支持经验值升级和直接达标升级两种方式

