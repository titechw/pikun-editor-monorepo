# 游戏场景系统设计方案

## 一、设计理念

通过统一的游戏平台，以场景化的方式训练和考核多种能力。游戏中的 NPC 发布任务，每个任务对应不同的能力训练或考核，完成任务后获得经验值并提升能力等级。

## 二、核心设计思路

### 2.1 游戏场景与课程的关系

- **游戏场景（Game Scenario）**：游戏中的具体场景/关卡
- **课程（Course）**：定义训练内容、经验值、考核标准
- **关系**：一个游戏场景可以绑定一个或多个课程，一个课程也可以被多个场景使用

### 2.2 NPC 和任务系统

- **NPC（Non-Player Character）**：游戏中的角色，发布任务
- **任务（Quest）**：NPC 发布的具体任务，关联课程和能力
- **任务类型**：
  - `training`：训练任务（完成获得经验值）
  - `assessment`：考核任务（通过后获得经验值并可能升级）
  - `daily`：日常任务（每日可完成）
  - `main`：主线任务（推进游戏剧情）

### 2.3 游戏会话和结果提交

- **游戏会话（Game Session）**：用户进入游戏场景时创建，包含会话密钥
- **结果提交**：通过 `courseId + sessionKey` 验证并提交结果
- **能力成长**：根据结果数据自动计算经验值和等级提升

## 三、数据库设计

### 3.1 游戏场景表（game_scenarios）

存储游戏场景信息。

```sql
CREATE TABLE IF NOT EXISTS pikun_db.game_scenarios (
    scenario_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    code VARCHAR(50) NOT NULL UNIQUE,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    scenario_type VARCHAR(50) NOT NULL DEFAULT 'training', -- 'training'、'assessment'、'mixed'、'story'
    cover_image_url VARCHAR(500),
    background_image_url VARCHAR(500),
    difficulty_level INTEGER DEFAULT 1 CHECK (difficulty_level >= 1 AND difficulty_level <= 10),
    estimated_duration INTEGER, -- 预计时长（分钟）
    sort_order INTEGER NOT NULL DEFAULT 0,
    is_published BOOLEAN NOT NULL DEFAULT false,
    metadata JSONB DEFAULT '{}'::JSONB, -- 存储场景配置、游戏规则等
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP WITH TIME ZONE DEFAULT NULL
);
```

### 3.2 场景课程绑定表（scenario_course_bindings）

建立场景与课程的关联关系，一个场景可以绑定多个课程（支持多能力训练）。

```sql
CREATE TABLE IF NOT EXISTS pikun_db.scenario_course_bindings (
    binding_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    scenario_id UUID NOT NULL REFERENCES pikun_db.game_scenarios(scenario_id) ON DELETE CASCADE,
    course_id UUID NOT NULL REFERENCES pikun_db.courses(course_id) ON DELETE CASCADE,
    is_primary BOOLEAN NOT NULL DEFAULT false, -- 是否为主要关联课程
    sort_order INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(scenario_id, course_id)
);
```

### 3.3 NPC 表（npcs）

存储 NPC 信息。

```sql
CREATE TABLE IF NOT EXISTS pikun_db.npcs (
    npc_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    code VARCHAR(50) NOT NULL UNIQUE,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    avatar_url VARCHAR(500),
    scenario_id UUID REFERENCES pikun_db.game_scenarios(scenario_id) ON DELETE SET NULL, -- NPC 所属场景
    position_x DECIMAL(10,2), -- NPC 在场景中的位置 X
    position_y DECIMAL(10,2), -- NPC 在场景中的位置 Y
    dialogue_data JSONB DEFAULT '{}'::JSONB, -- NPC 对话数据
    metadata JSONB DEFAULT '{}'::JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP WITH TIME ZONE DEFAULT NULL
);
```

### 3.4 任务表（quests）

存储 NPC 发布的任务信息。

```sql
CREATE TABLE IF NOT EXISTS pikun_db.quests (
    quest_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    npc_id UUID NOT NULL REFERENCES pikun_db.npcs(npc_id) ON DELETE CASCADE,
    code VARCHAR(50) NOT NULL UNIQUE,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    quest_type VARCHAR(50) NOT NULL, -- 'training'、'assessment'、'daily'、'main'
    course_id UUID REFERENCES pikun_db.courses(course_id) ON DELETE SET NULL, -- 关联的课程
    assessment_id UUID REFERENCES pikun_db.assessments(assessment_id) ON DELETE SET NULL, -- 如果是考核任务，关联考试
    prerequisite_quest_ids JSONB DEFAULT '[]'::JSONB, -- 前置任务 ID 列表
    exp_reward BIGINT DEFAULT 0, -- 完成任务获得的经验值
    item_rewards JSONB DEFAULT '[]'::JSONB, -- 物品奖励（如金币、道具等）
    sort_order INTEGER NOT NULL DEFAULT 0,
    is_published BOOLEAN NOT NULL DEFAULT false,
    metadata JSONB DEFAULT '{}'::JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP WITH TIME ZONE DEFAULT NULL
);
```

### 3.5 游戏会话表（game_sessions）

存储用户游戏会话信息，包含会话密钥。

```sql
CREATE TABLE IF NOT EXISTS pikun_db.game_sessions (
    session_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    uid BIGINT NOT NULL REFERENCES pikun_db.users(uid) ON DELETE CASCADE,
    scenario_id UUID NOT NULL REFERENCES pikun_db.game_scenarios(scenario_id) ON DELETE CASCADE,
    quest_id UUID REFERENCES pikun_db.quests(quest_id) ON DELETE SET NULL, -- 当前进行的任务
    session_key VARCHAR(64) NOT NULL UNIQUE, -- 会话密钥，用于结果提交验证
    status VARCHAR(50) NOT NULL DEFAULT 'active', -- 'active'、'completed'、'abandoned'、'expired'
    started_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP WITH TIME ZONE,
    expires_at TIMESTAMP WITH TIME ZONE, -- 会话过期时间
    metadata JSONB DEFAULT '{}'::JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 3.6 用户任务记录表（user_quest_records）

记录用户完成任务的情况。

```sql
CREATE TABLE IF NOT EXISTS pikun_db.user_quest_records (
    record_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    uid BIGINT NOT NULL REFERENCES pikun_db.users(uid) ON DELETE CASCADE,
    quest_id UUID NOT NULL REFERENCES pikun_db.quests(quest_id) ON DELETE CASCADE,
    session_id UUID REFERENCES pikun_db.game_sessions(session_id) ON DELETE SET NULL,
    status VARCHAR(50) NOT NULL DEFAULT 'in_progress', -- 'in_progress'、'completed'、'failed'、'abandoned'
    result_data JSONB DEFAULT '{}'::JSONB, -- 任务结果数据
    exp_earned BIGINT DEFAULT 0, -- 获得的经验值
    completed_at TIMESTAMP WITH TIME ZONE,
    metadata JSONB DEFAULT '{}'::JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

## 四、工作流程设计

### 4.1 进入游戏场景流程

```
1. 用户选择游戏场景
2. 系统创建游戏会话（game_session）
   - 生成 session_key（UUID 或随机字符串）
   - 设置过期时间（如 2 小时）
3. 返回场景信息和 session_key 给前端
4. 前端使用 session_key 进入游戏场景
```

### 4.2 NPC 交互和任务接取流程

```
1. 用户点击 NPC
2. 显示 NPC 对话和可接取的任务列表
3. 用户选择任务
4. 系统检查任务前置条件（是否完成前置任务）
5. 如果满足条件，创建或更新 game_session，关联 quest_id
6. 返回任务详情和游戏配置
```

### 4.3 任务完成和结果提交流程

```
1. 用户在游戏中完成任务
2. 前端收集结果数据（如：反应时间、得分、完成时间等）
3. 提交结果到后端 API：
   POST /api/game/submit-result
   {
     "sessionKey": "xxx",
     "courseId": "xxx",
     "resultData": {
       "reactionTime": 180,
       "score": 95,
       ...
     }
   }
4. 后端验证：
   - 验证 session_key 是否有效且未过期
   - 验证 course_id 是否与 session 关联的场景匹配
   - 验证用户是否有权限
5. 处理结果：
   - 保存训练/考试记录
   - 计算经验值
   - 判断是否达到等级标准（直接升级）
   - 或通过经验值升级
   - 更新用户能力等级
6. 返回结果：
   {
     "success": true,
     "expEarned": 100,
     "levelUp": true,
     "newLevel": 6,
     "message": "恭喜升级到高级+！"
   }
```

### 4.4 多能力同时训练

一个游戏场景可以绑定多个课程，从而同时训练多个能力：

```
场景：商业谈判模拟
绑定课程：
  - 课程1：反应力训练（反应时间 < 200ms）
  - 课程2：谋略能力训练（策略选择正确率 > 80%）
  - 课程3：沟通能力训练（对话选择合适度 > 70%）

用户完成任务后，系统会：
1. 根据 resultData 中的不同指标，分别计算各能力的经验值
2. 同时更新多个能力的等级
```

## 五、API 设计

### 5.1 游戏场景相关 API

```
GET    /api/game/scenarios                    # 获取游戏场景列表
GET    /api/game/scenarios/:scenarioId        # 获取场景详情
GET    /api/game/scenarios/:scenarioId/npcs   # 获取场景中的 NPC 列表
```

### 5.2 游戏会话相关 API

```
POST   /api/game/sessions                     # 创建游戏会话
GET    /api/game/sessions/:sessionId          # 获取会话信息
POST   /api/game/sessions/:sessionId/complete # 完成会话
```

### 5.3 NPC 和任务相关 API

```
GET    /api/game/npcs/:npcId                  # 获取 NPC 信息
GET    /api/game/npcs/:npcId/quests           # 获取 NPC 发布的任务列表
POST   /api/game/quests/:questId/accept       # 接取任务
GET    /api/game/quests/:questId              # 获取任务详情
```

### 5.4 结果提交 API

```
POST   /api/game/submit-result                # 提交游戏结果
Body: {
  sessionKey: string,
  courseId: string,
  resultData: {
    // 根据能力类型不同，数据结构不同
    reactionTime?: number,
    score?: number,
    accuracy?: number,
    // ...
  }
}
```

## 六、示例场景设计

### 6.1 反应力训练场景

**场景**：反应速度训练场
**NPC**：训练师张三
**任务**：
- 任务1：基础反应训练（训练任务）
  - 课程：反应力基础训练
  - 要求：完成 10 次颜色反应测试
  - 奖励：50 经验值
- 任务2：反应速度考核（考核任务）
  - 课程：反应力速度测试
  - 要求：平均反应时间 < 200ms
  - 奖励：100 经验值，达到标准可升级

### 6.2 多能力训练场景

**场景**：商业谈判模拟
**NPC**：商务顾问李四
**任务**：
- 任务1：快速决策训练（训练任务）
  - 课程1：反应力训练（快速做出决策）
  - 课程2：谋略能力训练（选择最佳策略）
  - 要求：在 5 秒内做出决策，策略正确率 > 70%
  - 奖励：反应力 30 经验值，谋略能力 50 经验值

### 6.3 综合能力考核场景

**场景**：创业挑战赛
**NPC**：投资人王五
**任务**：
- 任务1：创业项目评估（考核任务）
  - 课程1：商业分析能力
  - 课程2：决策能力
  - 课程3：沟通能力
  - 要求：完成项目评估，各项能力达到等级 5
  - 奖励：各能力 200 经验值

## 七、安全设计

### 7.1 会话密钥验证

- 会话密钥使用 UUID 或加密随机字符串
- 设置过期时间（如 2 小时）
- 每次提交结果时验证密钥有效性
- 防止重放攻击：使用时间戳和签名

### 7.2 结果数据验证

- 验证结果数据的合理性（如反应时间不能为负数）
- 防止作弊：检查结果数据是否符合正常范围
- 记录异常结果，便于后续分析

### 7.3 权限验证

- 验证用户是否有权限访问该场景
- 验证用户是否满足任务前置条件
- 验证用户是否已经完成过该任务（如果是唯一任务）

## 八、扩展性设计

### 8.1 支持多种游戏类型

- 通过 `scenario_type` 和 `metadata` 字段支持不同类型的游戏
- 可以是回合制、实时对战、解谜、模拟经营等

### 8.2 支持动态任务生成

- 通过 `metadata` 存储任务生成规则
- 支持每日任务、随机任务等动态生成

### 8.3 支持任务链和剧情

- 通过 `prerequisite_quest_ids` 实现任务链
- 通过 `scenario_type = 'story'` 实现主线剧情

## 九、实现建议

### 9.1 前端实现

1. **游戏场景渲染**：根据场景配置渲染游戏界面
2. **NPC 交互**：点击 NPC 显示对话和任务列表
3. **任务追踪**：显示当前任务进度和目标
4. **结果提交**：游戏结束后自动提交结果

### 9.2 后端实现

1. **会话管理**：创建、验证、更新游戏会话
2. **结果处理**：验证结果、计算经验值、更新等级
3. **任务系统**：任务接取、完成、奖励发放
4. **多能力处理**：同时处理多个能力的经验值和等级更新

### 9.3 数据库优化

1. **索引优化**：为常用查询字段添加索引
2. **分区策略**：如果数据量大，可以考虑按时间分区
3. **缓存策略**：缓存场景配置、NPC 信息等静态数据

## 十、总结

这个设计方案的优点：

1. **统一平台**：所有能力训练都在一个游戏平台中
2. **场景化**：通过 NPC 和任务系统，让训练更有趣
3. **灵活性**：支持单能力训练和多能力同时训练
4. **扩展性**：通过 JSONB 字段支持未来扩展
5. **安全性**：通过会话密钥和验证机制保证数据安全

通过 `courseId + sessionKey` 的关联方式，可以很好地实现能力成长系统，同时保持系统的灵活性和可扩展性。

