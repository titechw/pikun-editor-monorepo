# 快照存储实现总结

## 已完成的实现

### 1. 存储抽象层 ✅

- **StorageAdapter 接口** (`apps/server/src/core/storage/storage.interface.ts`)
  - 定义了统一的存储接口：`put`, `get`, `delete`, `list`, `deleteMany`
  - 支持本地文件存储和未来扩展 S3 存储

- **LocalFileStorage** (`apps/server/src/core/storage/local-file-storage.ts`)
  - 实现了本地文件系统存储
  - 存储路径：`{basePath}/{workspaceId}/{objectId}/snapshot_{timestamp}.gz`
  - 支持元数据存储（`.meta.json` 文件）

- **StorageFactory** (`apps/server/src/core/storage/storage.factory.ts`)
  - 工厂模式创建存储实例
  - 通过环境变量 `STORAGE_TYPE` 切换存储类型
  - 目前支持 `local`，未来可扩展 `s3`

### 2. 快照服务 ✅

- **SnapshotService** (`apps/server/src/services/snapshot.service.ts`)
  - 负责创建、存储和管理文档快照
  - 使用 gzip 压缩（可后续切换到 zstd）
  - 自动清理旧快照（保留最新的 N 个）
  - 快照存储在文件系统，元数据在数据库

### 3. 快照调度器 ✅

- **SnapshotScheduler** (`apps/server/src/services/snapshot-scheduler.service.ts`)
  - 定期创建快照，而不是每次保存都创建
  - 策略：
    - 每 N 次编辑后创建（默认 10 次）
    - 或每 T 秒创建一次（默认 2 秒）
  - 手动保存时强制创建快照

### 4. 文档服务集成 ✅

- **DocumentService** (`apps/server/src/services/document.service.ts`)
  - 集成快照调度器
  - 支持 `snapshot` 参数（Yjs Snapshot）
  - 支持 `forceSnapshot` 参数（手动保存）

### 5. API 更新 ✅

- **DocumentController** (`apps/server/src/api/documents/document.controller.ts`)
  - 更新 `updateDocument` 接口，支持 `snapshot` 和 `forceSnapshot` 参数

### 6. 前端更新 ✅

- **document.api.ts** (`apps/editor-demo/src/api/document.api.ts`)
  - `saveDocument` 方法同时发送 `content`（Doc State）和 `snapshot`（Snapshot）
  - 支持 `forceSnapshot` 参数

- **document.store.ts** (`apps/editor-demo/src/stores/document.store.ts`)
  - 手动保存时传递 `forceSnapshot: true`
  - 自动保存时不强制创建快照

## 存储机制说明

### 快照存储流程

1. **前端保存文档**：
   - 调用 `Y.encodeStateAsUpdate(ydoc)` 获取 Doc State（完整状态）
   - 调用 `Y.snapshot(ydoc)` 获取 Snapshot（状态向量）
   - 两者都 Base64 编码后发送到后端

2. **后端处理**：
   - 如果 `forceSnapshot: true`（手动保存），立即创建快照
   - 否则，由 `SnapshotScheduler` 决定是否创建快照
   - 快照数据压缩后存储到文件系统
   - 快照元数据存储到数据库

3. **快照清理**：
   - 自动保留最新的 N 个快照（默认 100 个）
   - 超过限制的旧快照自动删除

### 文件结构

```
storage/snapshots/
  {workspaceId}/
    {objectId}/
      snapshot_{timestamp}.gz          # 压缩的快照数据
      snapshot_{timestamp}.gz.meta.json # 快照元数据
```

### 数据库存储

- `document_snapshots` 表存储快照元数据
- `snapshot_data`: Snapshot（状态向量，可选）
- `doc_state`: Doc State（完整状态，存储在文件系统）
- `metadata`: 包含文件系统路径等信息

## 环境变量配置

```env
# 存储配置
STORAGE_TYPE=local                    # local 或 s3（未来）
STORAGE_BASE_PATH=./storage/snapshots # 本地存储路径

# 快照配置
SNAPSHOT_LIMIT=100                    # 最多保留的快照数量
SNAPSHOT_EDITS_THRESHOLD=10           # 编辑次数阈值
SNAPSHOT_TIME_THRESHOLD=300000          # 时间阈值（毫秒），5分钟
```

## 未来扩展

### S3 存储实现

只需实现 `S3Storage` 类，遵循 `StorageAdapter` 接口：

```typescript
export class S3Storage implements StorageAdapter {
  // 实现所有接口方法
  async put(key: string, data: Buffer, metadata?: Record<string, any>): Promise<void> {
    // S3 上传逻辑
  }
  // ...
}
```

然后在 `StorageFactory` 中添加：

```typescript
case 's3':
  StorageFactory.instance = new S3Storage(...);
  break;
```

## 注意事项

1. **Yjs Snapshot API**：`Y.snapshot(ydoc)` 可能需要通过 transaction 获取，如果 API 不存在，可以暂时不发送 snapshot
2. **压缩算法**：当前使用 gzip，后续可以切换到 zstd（需要安装 `node-zstd`）
3. **快照恢复**：需要实现从文件系统读取快照并恢复文档的功能
4. **并发安全**：快照调度器使用内存 Map，多实例部署时需要考虑分布式锁

