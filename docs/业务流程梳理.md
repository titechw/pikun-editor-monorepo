# 文档管理和登录注册业务流程梳理

本文档基于 AppFlowy 和 AppFlowy-Cloud 项目梳理出的业务流程和接口设计。

## 一、登录注册业务流程

### 1.1 用户注册

**接口路径**: `POST /api/auth/register`

**请求参数**:

```typescript
{
  email: string;
  password: string;
  name?: string;
}
```

**响应**:

```typescript
{
  success: boolean;
  data: {
    user: {
      uid: number;
      uuid: string;
      email: string;
      name: string;
    }
    token: string;
  }
}
```

**源码位置**:

- AppFlowy-Cloud: `src/api/user.rs` - 用户相关 API
- AppFlowy-Cloud: `src/biz/user/user_init.rs` - 用户初始化逻辑
- AppFlowy-Cloud: `libs/gotrue/src/` - 认证服务封装

### 1.2 用户登录

**接口路径**: `POST /api/auth/login`

**请求参数**:

```typescript
{
  email: string;
  password: string;
}
```

**响应**:

```typescript
{
  success: boolean;
  data: {
    user: UserProfile;
    token: string;
    refreshToken: string;
  }
}
```

**源码位置**:

- AppFlowy-Cloud: `libs/shared-entity/src/dto/auth_dto.rs` - 认证 DTO
- AppFlowy-Cloud: `src/biz/authentication/jwt.rs` - JWT 认证逻辑

### 1.3 Token 验证

**接口路径**: `GET /api/user/verify/{access_token}`

**响应**:

```typescript
{
  success: boolean;
  data: {
    is_new: boolean;
  }
}
```

**源码位置**:

- AppFlowy-Cloud: `src/api/user.rs:35-46` - verify_user_handler

### 1.4 获取用户信息

**接口路径**: `GET /api/user/profile`

**响应**:

```typescript
{
  success: boolean;
  data: {
    uid: number;
    uuid: string;
    email: string;
    name: string;
    metadata: Record<string, any>;
  }
}
```

**源码位置**:

- AppFlowy-Cloud: `src/api/user.rs:48-57` - get_user_profile_handler
- AppFlowy-Cloud: `src/biz/user/user_info.rs` - 用户信息业务逻辑

## 二、文档管理业务流程

### 2.1 新建文档

**接口路径**: `POST /api/workspace/{workspace_id}/collab/{object_id}`

**请求参数**:

```typescript
{
  collab_type: 'Document';
  encoded_collab?: string; // 可选的初始内容
  meta?: {
    title?: string;
    icon?: string;
  };
}
```

**响应**:

```typescript
{
  success: boolean;
  data: {
    object_id: string;
    workspace_id: string;
    created_at: string;
  }
}
```

**业务流程**:

1. 验证用户权限
2. 创建协作对象（Collab）
3. 如果提供了初始内容，保存到数据库
4. 返回文档 ID

**源码位置**:

- AppFlowy-Cloud: `src/api/workspace.rs:163-171` - create_collab_handler
- AppFlowy-Cloud: `src/biz/collab/ops.rs` - 协作对象操作
- AppFlowy-Cloud: `libs/database/src/collab.rs` - 数据库操作

### 2.2 更新文档

**接口路径**: `PUT /api/workspace/{workspace_id}/collab/{object_id}`

**请求参数**:

```typescript
{
  encoded_collab: string; // 编码后的文档内容
  doc_state?: string; // 文档状态（可选）
}
```

**响应**:

```typescript
{
  success: boolean;
  data: {
    object_id: string;
    updated_at: string;
  }
}
```

**业务流程**:

1. 验证用户权限
2. 解码并验证文档内容
3. 更新数据库中的文档内容
4. 记录变更历史（如果需要）
5. 触发索引更新（用于搜索）

**源码位置**:

- AppFlowy-Cloud: `src/api/workspace.rs:169` - update_collab_handler
- AppFlowy-Cloud: `src/biz/collab/ops.rs` - 更新逻辑

### 2.3 实时保存文档

**接口路径**: `POST /api/workspace/{workspace_id}/collab/{object_id}/web-update`

**请求参数**:

```typescript
{
  updates: Array<{
    update: string; // Base64 编码的更新数据
    client_id: number;
  }>;
}
```

**响应**:

```typescript
{
  success: boolean;
  data: {
    object_id: string;
    applied_updates: number;
  }
}
```

**业务流程**:

1. 接收 WebSocket 或 HTTP 更新
2. 应用增量更新到文档
3. 保存到数据库
4. 广播更新给其他客户端
5. 可选：触发自动保存检查点

**源码位置**:

- AppFlowy-Cloud: `src/api/workspace.rs:185-187` - post_web_update_handler
- AppFlowy-Cloud: `src/api/ws.rs` - WebSocket 处理
- AppFlowy-Cloud: `services/appflowy-collaborate/` - 协作服务

### 2.4 文档查询

#### 2.4.1 获取文档内容

**接口路径**: `GET /api/workspace/{workspace_id}/collab/{object_id}`

**请求参数**:

```typescript
{
  encode_type?: 'json' | 'binary'; // 返回格式
}
```

**响应**:

```typescript
{
  success: boolean;
  data: {
    object_id: string;
    encoded_collab: string;
    doc_state?: string;
    version: number;
  };
}
```

**源码位置**:

- AppFlowy-Cloud: `src/api/workspace.rs:168` - get_collab_handler

#### 2.4.2 获取文档列表

**接口路径**: `GET /api/workspace/{workspace_id}/documents`

**请求参数**:

```typescript
{
  page?: number;
  page_size?: number;
  sort_by?: 'created_at' | 'updated_at' | 'title';
  order?: 'asc' | 'desc';
  search?: string;
}
```

**响应**:

```typescript
{
  success: boolean;
  data: {
    documents: Array<{
      object_id: string;
      title: string;
      updated_at: string;
      created_at: string;
      owner_uid: number;
    }>;
    total: number;
    page: number;
    page_size: number;
  }
}
```

**源码位置**:

- AppFlowy-Cloud: `src/biz/collab/ops.rs` - 文档列表查询逻辑

### 2.5 文档搜索

**接口路径**: `GET /api/search/{workspace_id}`

**请求参数**:

```typescript
{
  query: string; // 搜索关键词
  limit?: number; // 返回结果数量限制
  offset?: number; // 偏移量
  threshold?: number; // 相似度阈值（0-1）
}
```

**响应**:

```typescript
{
  success: boolean;
  data: Array<{
    object_id: string;
    title: string;
    preview: string; // 内容预览
    score: number; // 相似度分数
    updated_at: string;
  }>;
}
```

**业务流程**:

1. 使用向量搜索（embedding）查找相似文档
2. 计算相似度分数
3. 返回匹配的文档片段和预览
4. 可选：生成搜索摘要

**源码位置**:

- AppFlowy-Cloud: `src/api/search.rs:17-52` - document_search_handler
- AppFlowy-Cloud: `src/biz/search/ops.rs` - 搜索业务逻辑
- AppFlowy-Cloud: `libs/indexer/src/collab_indexer/document_indexer.rs` - 文档索引器

### 2.6 文档变更历史管理

#### 2.6.1 获取文档快照列表

**接口路径**: `GET /api/workspace/{workspace_id}/collab/{object_id}/snapshots`

**请求参数**:

```typescript
{
  limit?: number;
  offset?: number;
}
```

**响应**:

```typescript
{
  success: boolean;
  data: {
    snapshots: Array<{
      snapshot_id: string;
      created_at: number; // 时间戳
      metadata?: Record<string, any>;
    }>;
    total: number;
  }
}
```

**源码位置**:

- AppFlowy-Cloud: `migrations/20240412083446_history_init.sql` - 快照表结构
- AppFlowy-Cloud: `tests/collab_history/document_history.rs` - 历史测试

#### 2.6.2 获取最新历史记录

**接口路径**: `GET /api/workspace/{workspace_id}/collab/{object_id}/latest-history`

**响应**:

```typescript
{
  success: boolean;
  data: {
    snapshot_id: string;
    doc_state: string; // 文档状态
    snapshot: string; // 快照数据
    created_at: number;
  }
}
```

**源码位置**:

- AppFlowy-Cloud: `tests/collab_history/document_history.rs:59-64` - get_latest_history

#### 2.6.3 恢复文档到指定版本

**接口路径**: `POST /api/workspace/{workspace_id}/collab/{object_id}/restore`

**请求参数**:

```typescript
{
  snapshot_id: string;
}
```

**响应**:

```typescript
{
  success: boolean;
  data: {
    object_id: string;
    restored_at: string;
  }
}
```

## 三、数据库表结构

### 3.1 用户表 (af_user)

**源码位置**: `AppFlowy-Cloud/migrations/20230312043024_user.sql`

```sql
CREATE TABLE af_user (
    uid BIGINT PRIMARY KEY,
    uuid UUID NOT NULL UNIQUE,
    email TEXT NOT NULL DEFAULT '' UNIQUE,
    password TEXT NOT NULL DEFAULT '',
    name TEXT NOT NULL DEFAULT '',
    metadata JSONB DEFAULT '{}'::JSONB,
    encryption_sign TEXT DEFAULT NULL,
    deleted_at TIMESTAMP WITH TIME ZONE DEFAULT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 协作对象表 (af_collab)

**源码位置**: `AppFlowy-Cloud/migrations/20230906102652_collab.sql`

```sql
CREATE TABLE af_collab (
    oid TEXT NOT NULL,
    blob BYTEA NOT NULL,
    len INTEGER,
    partition_key INTEGER NOT NULL,
    encrypt INTEGER DEFAULT 0,
    owner_uid BIGINT NOT NULL,
    deleted_at TIMESTAMP WITH TIME ZONE DEFAULT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    workspace_id UUID NOT NULL REFERENCES af_workspace(workspace_id) ON DELETE CASCADE,
    PRIMARY KEY (oid, partition_key)
) PARTITION BY LIST (partition_key);

-- 文档类型分区表
CREATE TABLE af_collab_document PARTITION OF af_collab FOR VALUES IN (0);
```

### 3.3 快照元数据表 (af_snapshot_meta)

**源码位置**: `AppFlowy-Cloud/migrations/20240412083446_history_init.sql`

```sql
CREATE TABLE af_snapshot_meta (
    oid TEXT NOT NULL,
    workspace_id UUID NOT NULL,
    snapshot BYTEA NOT NULL,
    snapshot_version INTEGER NOT NULL,
    partition_key INTEGER NOT NULL,
    created_at BIGINT NOT NULL,
    metadata JSONB,
    PRIMARY KEY (oid, created_at, partition_key)
) PARTITION BY LIST (partition_key);

CREATE TABLE af_snapshot_meta_document PARTITION OF af_snapshot_meta FOR VALUES IN (0);
```

### 3.4 快照状态表 (af_snapshot_state)

```sql
CREATE TABLE af_snapshot_state (
    snapshot_id UUID NOT NULL DEFAULT uuid_generate_v4(),
    workspace_id UUID NOT NULL,
    oid TEXT NOT NULL,
    doc_state BYTEA NOT NULL,
    doc_state_version INTEGER NOT NULL,
    deps_snapshot_id UUID,
    partition_key INTEGER NOT NULL,
    created_at BIGINT NOT NULL,
    PRIMARY KEY (snapshot_id, partition_key)
) PARTITION BY LIST (partition_key);

CREATE TABLE af_snapshot_state_document PARTITION OF af_snapshot_state FOR VALUES IN (0);
```

### 3.5 文档嵌入表 (af_collab_embeddings)

**源码位置**: `AppFlowy-Cloud/migrations/20240614171931_collab_embeddings.sql`

用于向量搜索的文档嵌入存储。

## 四、关键技术点

### 4.1 实时协作

- 使用 Yjs/CRDT 进行冲突解决
- WebSocket 进行实时同步
- 增量更新机制

**源码位置**:

- AppFlowy-Cloud: `services/appflowy-collaborate/` - 协作服务
- AppFlowy-Cloud: `libs/collab-stream/` - 协作流处理

### 4.2 文档索引和搜索

- 使用向量嵌入（Embedding）进行语义搜索
- 自动索引文档内容
- 支持全文搜索和向量搜索结合

**源码位置**:

- AppFlowy-Cloud: `libs/indexer/src/collab_indexer/document_indexer.rs`
- AppFlowy-Cloud: `src/biz/search/ops.rs`

### 4.3 权限控制

- 基于角色的访问控制（RBAC）
- 工作空间级别的权限管理
- 文档级别的权限控制

**源码位置**:

- AppFlowy-Cloud: `libs/access-control/` - 访问控制库
- AppFlowy-Cloud: `src/biz/authentication/jwt.rs` - JWT 认证

### 4.4 数据压缩

- 文档内容压缩存储
- 支持多种压缩算法

**源码位置**:

- AppFlowy-Cloud: `src/domain/compression/` - 压缩处理

## 五、安全注意事项

1. **SQL 注入防护**: 使用参数化查询，禁止字符串拼接 SQL
2. **XSS 防护**: 对用户输入进行转义
3. **CSRF 防护**: 使用 CSRF Token
4. **权限验证**: 每个接口都要验证用户权限
5. **数据加密**: 敏感数据加密存储
6. **速率限制**: API 请求频率限制

## 六、性能优化

1. **缓存策略**: 使用 Redis 缓存热点数据
2. **数据库索引**: 合理使用数据库索引
3. **分页查询**: 大数据量使用分页
4. **异步处理**: 耗时操作异步处理
5. **连接池**: 数据库连接池管理



