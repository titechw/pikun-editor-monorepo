# 小版本和大版本计算逻辑说明

## 版本类型判断流程

### 1. 何时创建快照

#### 自动保存（`recordEdit` 方法）
- **触发条件**：满足以下任一条件
  - 编辑次数 >= `SNAPSHOT_EDITS_THRESHOLD`（默认：10次）
  - 时间间隔 >= `SNAPSHOT_TIME_THRESHOLD`（默认：5分钟 = 300000毫秒）

#### 手动保存（`createSnapshotManually` 方法）
- **触发条件**：用户点击保存按钮
- **总是创建快照**（无论编辑次数或时间间隔）

### 2. 版本类型判断（策略模式）

使用 **组合策略（CompositeOrStrategy）**，只要满足**任意一个条件**就创建**大版本**，否则创建**小版本**。

#### 策略1：时间间隔策略（TimeIntervalStrategy）
```typescript
// 如果距离上次快照 >= 5分钟，创建大版本
timeSinceLastSnapshot >= 300000 (5分钟)
```

#### 策略2：内容变化策略（ContentChangeStrategy）
```typescript
// 如果内容变化 >= 10KB，创建大版本
Math.abs(currentSize - lastSnapshotSize) >= 10000 (10KB)
```

#### 策略3：变更频次策略（EditFrequencyStrategy）
```typescript
// 如果编辑次数 >= 50次，创建大版本
editCount >= 50
```

### 3. 判断逻辑

```typescript
// 组合策略：任意一个满足就返回 true（创建大版本）
const isMajor = 
  timeSinceLastSnapshot >= 5分钟 ||
  contentChange >= 10KB ||
  editCount >= 50次;

const versionType = isMajor ? 'major' : 'minor';
```

## 实际场景示例

### 场景1：自动保存 - 时间间隔触发
```
上次快照时间：18:22:00
当前时间：18:27:22
时间间隔：5分22秒 > 5分钟 ✅
→ 创建大版本
```

### 场景2：自动保存 - 编辑次数触发
```
上次快照后编辑次数：15次 > 10次 ✅
但时间间隔：2分钟 < 5分钟
→ 创建快照，但判断版本类型：
  - 时间间隔 < 5分钟 ❌
  - 内容变化 < 10KB ❌
  - 编辑次数 15 < 50次 ❌
→ 创建小版本
```

### 场景3：手动保存
```
用户点击保存按钮
→ 总是创建快照
→ 判断版本类型：
  - 如果满足任意策略条件 → 大版本
  - 否则 → 小版本
```

### 场景4：初始快照
```
文档创建时
→ forceMajorVersion = true
→ 强制创建大版本
```

## 环境变量配置

```env
# 自动保存触发阈值
SNAPSHOT_EDITS_THRESHOLD=10          # 编辑次数阈值（默认：10次）
SNAPSHOT_TIME_THRESHOLD=300000       # 时间间隔阈值（默认：5分钟）

# 大版本判断策略阈值
SNAPSHOT_CONTENT_CHANGE_THRESHOLD=10000    # 内容变化阈值（默认：10KB）
SNAPSHOT_EDIT_FREQUENCY_THRESHOLD=50       # 变更频次阈值（默认：50次）
```

## 关键代码位置

1. **自动保存版本判断**：`snapshot-scheduler.service.ts` 第233-247行
2. **手动保存版本判断**：`snapshot-scheduler.service.ts` 第404-425行
3. **策略实现**：`snapshot-scheduler.service.ts` 第35-108行

## 总结

- **大版本**：满足时间间隔、内容变化或变更频次任一条件
- **小版本**：不满足上述条件，但需要创建快照时
- **初始快照**：总是大版本
- **手动保存**：根据策略判断，可能大版本也可能小版本

